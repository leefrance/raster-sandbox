<!DOCTYPE html>
<html>
<head>
    <title>Raster Tile Viewer - Enhanced Native GDAL</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
        #map { height: 100vh; width: 100vw; }
        .info { padding: 6px 8px; font: 14px/16px Arial, Helvetica, sans-serif; background: white; background: rgba(255,255,255,0.8); box-shadow: 0 0 15px rgba(0,0,0,0.2); border-radius: 5px; }
        .layer-control { background: white; padding: 10px; border-radius: 5px; box-shadow: 0 0 15px rgba(0,0,0,0.2); max-height: 300px; overflow-y: auto; }
        .layer-item { margin: 5px 0; }
        .opacity-control { margin-left: 20px; font-size: 12px; }
        .performance-info { position: absolute; top: 10px; left: 10px; z-index: 1000; background: rgba(0,128,0,0.8); color: white; padding: 5px 10px; border-radius: 3px; font-family: monospace; font-size: 12px; }
        .loading { color: #666; font-style: italic; }
    </style>
</head>
<body>
    <div class="performance-info">
        ⚡ Enhanced Native GDAL | Individual Processing | <span id="layer-count">...</span> Layers
    </div>
    <div id="map"></div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Initialize map
        var map = L.map('map').setView([47.7511, -120.7401], 11);
        
        // Base map
        var baseMap = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);
        
        // Function to discover available tile layers
        async function discoverLayers() {
            try {
                // Known layers from tile generation
                const knownLayers = ['shadows', 'texture'];
                const availableLayers = [];
                
                for (const layer of knownLayers) {
                    try {
                        // Test if layer exists by trying to fetch a tile
                        const response = await fetch(`../tiles/${layer}/9/`, { method: 'HEAD' });
                        if (response.ok || response.status === 404) {
                            // 404 might mean the specific tile doesn't exist but the layer does
                            availableLayers.push(layer);
                        }
                    } catch (e) {
                        // Layer might still exist, add it anyway
                        availableLayers.push(layer);
                    }
                }
                
                return availableLayers.length > 0 ? availableLayers : knownLayers;
            } catch (error) {
                console.error('Error discovering layers:', error);
                // Fallback to known layers
                return ['shadows', 'texture'];
            }
        }
        
        // Initialize layers
        async function initializeLayers() {
            const availableLayers = await discoverLayers();
            const tileLayers = {};
            
            // Create tile layers
            availableLayers.forEach(function(layerName) {
                tileLayers[layerName] = L.tileLayer(`../tiles/${layerName}/{z}/{x}/{y}.png`, {
                    attribution: `${layerName} tiles (Enhanced Native GDAL)`,
                    maxZoom: 13,
                    opacity: 0.8,
                    errorTileUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg=='
                });
            });
            
            // Update layer count
            document.getElementById('layer-count').textContent = availableLayers.length;
            
            // Add first layer by default
            const firstLayer = availableLayers[0];
            if (firstLayer && tileLayers[firstLayer]) {
                tileLayers[firstLayer].addTo(map);
                
                // Auto-fit to bounds of the first loaded tile layer
                setTimeout(() => {
                    const bounds = L.latLngBounds([
                        [47.70, -120.80],
                        [47.80, -120.68]
                    ]);
                    map.fitBounds(bounds);
                }, 500);
            }
            
            // Create layer control
            const layerControl = L.control({ position: 'topright' });
            layerControl.onAdd = function(map) {
                const div = L.DomUtil.create('div', 'layer-control');
                div.innerHTML = '<h4>Layers</h4>';
                
                availableLayers.forEach(function(layerName) {
                    const layerDiv = L.DomUtil.create('div', 'layer-item', div);
                    
                    const checkbox = L.DomUtil.create('input', '', layerDiv);
                    checkbox.type = 'checkbox';
                    checkbox.id = 'layer-' + layerName;
                    checkbox.checked = layerName === firstLayer;
                    
                    const label = L.DomUtil.create('label', '', layerDiv);
                    label.htmlFor = 'layer-' + layerName;
                    label.innerHTML = ' ' + layerName;
                    
                    // Opacity slider
                    const opacityDiv = L.DomUtil.create('div', 'opacity-control', layerDiv);
                    const opacityLabel = L.DomUtil.create('label', '', opacityDiv);
                    opacityLabel.innerHTML = 'Opacity: ';
                    const opacitySlider = L.DomUtil.create('input', '', opacityDiv);
                    opacitySlider.type = 'range';
                    opacitySlider.min = '0';
                    opacitySlider.max = '1';
                    opacitySlider.step = '0.1';
                    opacitySlider.value = '0.8';
                    
                    // Event handlers
                    checkbox.onchange = function() {
                        if (this.checked) {
                            tileLayers[layerName].addTo(map);
                        } else {
                            map.removeLayer(tileLayers[layerName]);
                        }
                    };
                    
                    opacitySlider.oninput = function() {
                        tileLayers[layerName].setOpacity(this.value);
                    };
                });
                
                return div;
            };
            layerControl.addTo(map);
            
            console.log('⚡ Enhanced Native GDAL tile viewer loaded with layers:', availableLayers);
        }
        
        // Initialize when page loads
        initializeLayers();
    </script>
</body>
</html>
